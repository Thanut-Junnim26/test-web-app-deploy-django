{% extends "store/base.html" %}
{% load static %}

{% block title %}
    {% if category %}{{ category.name }}{% else %}Products{% endif %}
{% endblock %}

{% block content %}
    <div class="hero">
        <h1>Welcome to MediStore</h1>
        <p>Your trusted partner for health and wellness.</p>
    </div>

    <div style="display: flex; gap: 2rem;">
        <aside class="sidebar" style="width: 250px; flex-shrink: 0;">
            <h3>Categories</h3>
            <ul class="category-list">
                <li>
                    <a href="{% url 'store:product_list' %}" {% if not category %}class="active"{% endif %}>All</a>
                </li>
                {% for c in categories %}
                    <li>
                        <a href="{{ c.get_absolute_url }}" {% if category.slug == c.slug %}class="active"{% endif %}>{{ c.name }}</a>
                    </li>
                {% endfor %}
            </ul>
        </aside>

        <div style="flex-grow: 1;">
            <div id="product-grid-container">
                <div class="product-grid">
                    {% for medicine in medicines %}
                        <div class="product-card">
                            <a href="{{ medicine.get_absolute_url }}">
                                <img src="{% if medicine.image %}{{ medicine.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}" class="product-image">
                            </a>
                            <div class="product-info">
                                <div class="product-category">{{ medicine.category.name }}</div>
                                <div class="product-name">
                                    <a href="{{ medicine.get_absolute_url }}">{{ medicine.name }}</a>
                                </div>
                                <div class="product-price">${{ medicine.price }}</div>
                                <form action="{% url 'store:cart_add' medicine.id %}" method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="quantity" value="1">
                                    <input type="hidden" name="override" value="False">
                                    <input type="submit" value="Add to cart" class="btn" style="width: 100%; margin-top: 1rem; padding: 0.5rem;">
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const productGridContainer = document.getElementById('product-grid-container');
            const categoryList = document.querySelector('.category-list');

            if (categoryList) {
                categoryList.addEventListener('click', function(e) {
                    if (e.target.tagName === 'A') {
                        e.preventDefault();
                        const url = e.target.getAttribute('href');
                        
                        // Update active state visually
                        const currentActive = categoryList.querySelector('a.active');
                        if (currentActive) currentActive.classList.remove('active');
                        e.target.classList.add('active');

                        fetch(url)
                            .then(response => response.text())
                            .then(html => {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const newProductGrid = doc.querySelector('.product-grid');
                                
                                if (newProductGrid) {
                                    productGridContainer.innerHTML = '';
                                    productGridContainer.appendChild(newProductGrid);
                                    history.pushState(null, '', url);
                                }
                            })
                            .catch(error => console.error('Error loading products:', error));
                    }
                });
            }

            window.addEventListener('popstate', function() {
                location.reload();
            });
        });
    </script>
{% endblock %}
